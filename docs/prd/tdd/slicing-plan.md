# Red/Green/Refactor 实施切片计划（Phase 1 -> Phase 2）

版本：v1.0  
状态：Draft  
负责人：PM / Architect / Lead  
目标：按最小可交付单元推进，避免大爆炸改造

## 1. 切片原则

- 每个切片都要有“先失败的测试”。
- 每个切片都必须可独立回滚。
- 每个切片都必须可观测（至少 1 个事件或指标）。
- 优先做“减少歧义与返工”的切片。

## 2. 切片列表

### [Slice 0] 主键与术语冻结（Red 优先）

目标：

- 冻结 `IssueRef`、`run_id`、`assignee` 语义。

先失败测试：

- `CT-REF-*`、`CT-RUN-*`、`CT-CLAIM-*`

交付：

- 契约文档与测试清单通过评审。

### [Slice 1] 开工门槛（Phase 1 Hard 条件）

目标：

- 未 claim、依赖未满足、`needs-human` 的情况不得开工。

先失败测试：

- `P1-AT-001`、`P1-AT-002`、`P1-AT-003`

Green 结果：

- 能明确拒绝并给出可审计阻塞说明。

### [Slice 2] 最小执行回填

目标：

- Worker 产物经过 Lead 规范化写回 Issue。

先失败测试：

- `P1-AT-004`、`P1-AT-005`、`P1-AT-006`

Green 结果：

- 缺少 Changes/Tests 时不可关闭。

### [Slice 3] 真实任务闭环

目标：

- 至少 1 个真实任务完成 open -> close 全流程。

先失败测试：

- `P1-AT-007`、`P1-AT-008`

Green 结果：

- 形成可复盘样本与证据链。

### [Slice 4] run 幂等（Phase 2 前置）

目标：

- 只接受 active run 的结果，迟到结果丢弃。

先失败测试：

- `CT-RUN-002`、`CT-WORK-002`

Green 结果：

- 无状态回滚，无旧结果覆盖。

### [Slice 5] 轮询 + cursor（Phase 2 MVP）

目标：

- 常驻 Lead 可增量消费事件并恢复。

先失败测试：

- 重启后重复消费/漏消费场景测试

Green 结果：

- 至少 1 个角色自动闭环可运行。

## 3. RACI（最小）

- PM：定义切片优先级、验收口径、发布节奏。
- Architect：冻结契约边界与兼容策略。
- Lead：实施与规范化写回，保证单写者原则。
- QA：维护 ATDD/Contract 通过率与回归清单。
- Integrator：收敛发布与最终关闭。

## 4. 每个切片的完成定义（DoD）

- 对应 Red 测试先失败后通过。
- 有至少 1 条 Issue 证据回填记录。
- 有明确回滚策略。
- 文档更新与实现保持一致。

## 5. 节奏建议

- 每个切片 0.5-2 天。
- 每完成 2 个切片做一次小复盘。
- 禁止跨 3 个以上切片并行开发，避免上下游漂移。
